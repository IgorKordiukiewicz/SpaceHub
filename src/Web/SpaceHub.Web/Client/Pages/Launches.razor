@page "/launches"
@inject HttpClient _httpClient
@using Application.Enums;
@using Application.Features.Launches;
@using MediatR;
@using MudBlazor
@using SpaceHub.Web.Shared;
@using System.Timers;

@if(_viewModel is not null)
{
    <MudGrid Class="d-flex">
        <MudItem xs="12" Class="pb-0">
            <MudRadioGroup T="ETimeFrame" SelectedOptionChanged="OnTimeFrameChanged" SelectedOption="_timeFrame">
                <MudRadio Option="ETimeFrame.Upcoming" Color="Color.Success">Upcoming</MudRadio>
                <MudRadio Option="ETimeFrame.Previous" Color="Color.Error">Previous</MudRadio>
            </MudRadioGroup>
        </MudItem>
        <MudItem xs="12" Class="pt-0">
            <MudTextField Label="Search" T="string" TextChanged="OnSearchChanged"
                      Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" AdornmentColor="Color.Primary" />
        </MudItem>
            @foreach (var launch in _viewModel.Launches)
            {
                <MudItem xs="12" Class="mb-10">
                <MudPaper Style="background-color: var(--mud-palette-primary);">
                        <MudPaper>
                            <MudGrid>
                            <MudItem md="12" lg="3" Class="d-flex justify-center">
                                <MudImage Src="@launch.ImageUrl" ObjectFit="ObjectFit.Cover" Class="rounded-circle" Width="250" Height="250"/>
                            </MudItem>
                            <MudItem md="12" lg="8">
                                <MudText Typo="Typo.h4" Color="Color.Primary" Align="Align.Center">
                                    @launch.Name
                                </MudText>
                                <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary">
                                    @launch.AgencyName | @launch.PadLocationName | @launch.Date.GetValueOrDefault().ToString("d")
                                </MudText>
                                <MudText Typo="Typo.body2" Align="Align.Center" Class="py-1">
                                    @launch.MissionDescription
                                </MudText>
                                <MudDivider/>
                                <MudText Typo="Typo.h3" Align="Align.Center" Class="pt-1">
                                    @if(launch.Upcoming)
                                    {
                                        @launch.TimeToLaunch?.ToString("dd\\:hh\\:mm\\:ss")
                                    }
                                    else
                                    {
                                        @launch.Date
                                    }
                                </MudText>
                                <MudText Typo="Typo.h5" Align="Align.Center" Color="@StatusColor(launch.Status)">
                                    (@launch.Status)
                                </MudText>
                            </MudItem>
                            <MudItem md="12" lg="1" Class="d-flex align-content-end flex-wrap justify-center">
                                <MudFab Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Add" OnClick="(e) => ToggleLaunchDetails(launch.Id)" />
                            </MudItem>
                        </MudGrid>
                        </MudPaper>
                        @if(_expandedLaunches.TryGetValue(launch.Id, out var details) && details.Visible)
                        {
                            <div class="d-flex justify-center flex-grow pt-8 pb-4">
                            <MudProgressCircular Color="Color.Default" Indeterminate="true" />
                            </div>
                        }
                    </MudPaper>
                </MudItem>
            }

        <div class="d-flex flex-column align-center my-8">
            <MudPagination Count="@_viewModel.TotalPagesCount" Size="Size.Large" SelectedChanged="OnPageChanged" />
        </div>
    </MudGrid>
}

@code {
    [Inject]
    private IJSRuntime _jsRuntime { get; set; }

    private GetLaunchesResult _viewModel;

    private ETimeFrame _timeFrame = ETimeFrame.Upcoming;
    private string? _searchValue = null;
    private int _pageNumber = 1;
    private int _itemsPerPage = 10;

    private Timer _timer;

    private class LaunchDetailed
    {
        public LaunchExpandedViewModel Details { get; init; }
        public bool Visible { get; set; } = false;
    }

    private Dictionary<string, LaunchDetailed> _expandedLaunches = new();

    protected override async Task OnInitializedAsync()
    {
        await UpdateLaunches();

        _timer = new(1000);
        _timer.Elapsed += UpdateCountdownTimers;
        _timer.Start();
    }

    private void UpdateCountdownTimers(object? sender, ElapsedEventArgs e)
    {
        if(_viewModel is null)
        {
            return;
        }

        var now = DateTime.Now;
        foreach(var launch in _viewModel.Launches)
        {
            if(launch.Date is null)
            {
                continue;
            }

            if(launch.Date < now)
            {
                launch.TimeToLaunch = TimeSpan.FromMinutes(0.0);
            }
            else
            {
                launch.TimeToLaunch = launch.Date.Value - now;
            }
        }

        StateHasChanged();
    }

    private async Task UpdateLaunches()
    {
        var url = new UrlBuilder("api/space/launches")
            .AddParameter("timeFrame", _timeFrame)
            .AddParameter("searchValue", _searchValue)
            .AddParameter("pageNumber", _pageNumber)
            .AddParameter("itemsPerPage", _itemsPerPage)
            .Url;
        _viewModel = await _httpClient.GetFromJsonAsync<GetLaunchesResult>(url);
    }

    private async Task OnTimeFrameChanged(ETimeFrame timeFrame)
    {
        _timeFrame = timeFrame;
        await UpdateLaunches();
    }

    private async Task OnSearchChanged(string searchValue)
    {
        _searchValue = searchValue;
        await UpdateLaunches();
    }

    private async Task OnPageChanged(int pageNumber)
    {
        _pageNumber = pageNumber;
        await UpdateLaunches();
        await _jsRuntime.InvokeVoidAsync("window.scrollTo", 0, 0);
    }

    private Color StatusColor(string status) => status.ToLower() switch
    {
        "go for launch" or "launch successful" => Color.Success,
        "to be confirmed" or "to be determined" => Color.Warning,
        "launch failure" => Color.Error,
        _ => Color.Default
    };

    private void ToggleLaunchDetails(string id)
    {
        if(!_expandedLaunches.TryGetValue(id, out var launchDetailed))
        {
            // GET from api
            _expandedLaunches.Add(id, new LaunchDetailed() 
            { 
                Details = new(), 
                Visible = true 
            });
        }
        else
        {
            launchDetailed.Visible = !launchDetailed.Visible;
        }
    }
}
